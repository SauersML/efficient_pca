name: Rust CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: read
  issues: write

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        backend: [openblas, mkl, faer]
        include:
          - backend: openblas
            feature: backend_openblas
            rustflags: ""
          - backend: mkl
            feature: backend_mkl
            rustflags: "-L/opt/intel/oneapi/mkl/latest/lib/intel64"
          - backend: faer
            feature: backend_faer
            rustflags: "--cfg openblas"

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt, clippy

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy scikit-learn scipy

      - name: Install OpenBLAS
        if: matrix.backend == 'openblas'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y libopenblas-dev

      - name: Install Intel MKL
        if: matrix.backend == 'mkl'
        run: |
          wget -qO- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB | 
            sudo gpg --dearmor --output /usr/share/keyrings/intel-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/intel-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main" | 
            sudo tee /etc/apt/sources.list.d/oneAPI.list
          sudo apt-get update -qq
          sudo apt-get install -y intel-oneapi-mkl-devel
          echo "MKL_ROOT=/opt/intel/oneapi/mkl/latest" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=/opt/intel/oneapi/mkl/latest/lib/intel64${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}" >> "$GITHUB_ENV"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.backend }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.backend }}-
            ${{ runner.os }}-cargo-

      - name: Build
        run: |
          if [[ "${{ matrix.feature }}" == "backend_openblas" ]]; then
            cargo build --release --features ${{ matrix.feature }}
          else
            cargo build --release --no-default-features --features ${{ matrix.feature }}
          fi
        env:
          RUSTFLAGS: ${{ matrix.rustflags }}

      - name: Test
        run: |
          if [[ "${{ matrix.feature }}" == "backend_openblas" ]]; then
            cargo test --features ${{ matrix.feature }}
          else
            cargo test --no-default-features --features ${{ matrix.feature }}
          fi
        env:
          RUSTFLAGS: ${{ matrix.rustflags }}
          RUST_BACKTRACE: 1

      - name: Benchmark
        run: |
          if [[ "${{ matrix.feature }}" == "backend_openblas" ]]; then
            cargo bench --features ${{ matrix.feature }}
          else
            cargo bench --no-default-features --features ${{ matrix.feature }}
          fi
        env:
          RUSTFLAGS: ${{ matrix.rustflags }}
          RUST_BACKTRACE: 1

      - name: Generate failure report
        if: failure()
        run: |
          cargo install getdoc --locked
          getdoc --features ${{ matrix.feature }}
          mv report.md failure-report-${{ matrix.backend }}.md

      - name: Upload failure report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-report-${{ matrix.backend }}
          path: failure-report-${{ matrix.backend }}.md

  consolidate-failures:
    if: always() && needs.test.result == 'failure'
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Download failure reports
        uses: actions/download-artifact@v4
        with:
          pattern: failure-report-*
          path: reports
          merge-multiple: true

      - name: Consolidate reports
        run: |
          exec > consolidated-report.md
          cat << EOF
          # CI Failure Report
          
          **Run ID:** ${{ github.run_id }}
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          EOF
          
          for report in reports/failure-report-*.md; do
            if [[ -f "$report" ]]; then
              backend=$(basename "$report" .md | sed 's/failure-report-//')
              cat << EOF
          
          ## Backend: ${backend}
          
          EOF
              cat "$report"
              echo -e "\n---\n"
            fi
          done

      - name: Upload consolidated report
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-failure-report
          path: consolidated-report.md

      - name: Close stale issues
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const cutoff = new Date(Date.now() - 24 * 60 * 60 * 1000);
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure,automated',
            });
            
            for (const issue of issues) {
              if (new Date(issue.created_at) < cutoff && 
                  issue.title.includes('CI Failure Report')) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
              }
            }

      - name: Create failure issue
        if: (github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'pull_request' && github.base_ref == 'main')
        uses: peter-evans/create-issue-from-file@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "CI Failure Report - Run ${{ github.run_id }}"
          content-filepath: consolidated-report.md
          labels: ci-failure,automated
